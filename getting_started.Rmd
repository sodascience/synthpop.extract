---
title: "Reproducible CBS data sets using the synthpop package"
author: "Kyuri Park & Erik-Jan van Kesteren"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    css: style.css
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: lumen

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message=FALSE, 
                      warning = FALSE, 
                      comment = NA)
```

<div class="head">
We are trying to establish a procedure for exporting synthetic datasets based on real datasets at Statistics Netherlands ([CBS](https://www.cbs.nl/en-gb)). We want to use this synthetic data to make research reproducible. The general procedure is as follows: 

1. Extract parameters of models based on the original data using the `synthpop` package.
2. Export the parameters to Excel and store them in an xlsx file.
3. Import the xlsx file from the CBS environment into your local device.
4. Read in the excel file and load the parameters back in R.
5. Generate synthetic data based on the model parameters.

Here we will illustrate each step of the procedure using an example data set.
</div>

<hr>

# Preparation

First, we need to load the following packages and import the functions (i.e., `synp_get_param`, `synp_read_sheets`, `synp_gen_syndat`) from the `synthpop_extractor.R` file. 

```{r}
## load packages
library(tidyverse)
library(skimr)
library(readxl)
library(writexl)
library(synthpop)
library(lavaan)
library(lavaanPlot)

## import the functions
source("synthpop_extractor.R")
```


# Example dataset
`big5_kag.csv` is a [Big Five personality traits](https://en.wikipedia.org/wiki/Big_Five_personality_traits) data set found on [kaggle](https://www.kaggle.com/datasets/tunguz/big-five-personality-test). It contains more than a million (1,015,342) answers collected from 2016 to 2018. 
It includes 50 questions, which participants rate by themselves on a five-point-Likert scale where a *1* represents *complete disagreement*, a *3* for a *neutral* response and a *5* for *full agreement*. For ease of computation, here we will analyze only a subset of the dataset (e.g., 100,000 answers for 25 questions). The cleaned dataset can be found in the `data` folder (`big5.RDS`) and the code for cleaning up can be found in `process_rawdata.R` file. 

<details>
  <summary>***See the set of questions used***.</summary>
  <br>
**EXT = Extraversion**

- EXT1 I am the life of the party.
- EXT2 I don’t talk a lot.
- EXT3 I feel comfortable around people.
- EXT4 I keep in the background.
- EXT5 I start conversations.

**EST = Emotional Stability**

- EST1 I get stressed out easily.
- EST2 I am relaxed most of the time.
- EST3 I worry about things.
- EST4 I seldom feel blue.
- EST5 I am easily disturbed.

**AGR = Agreeableness**

- AGR1 I feel little concern for others.
- AGR2 I am interested in people.
- AGR3 I insult people.
- AGR4 I sympathize with others’ feelings.
- AGR5 I am not interested in other people’s problems.

**CSN = Conscientiousness**

- CSN1 I am always prepared.
- CSN2 I leave my belongings around.
- CSN3 I pay attention to details.
- CSN4 I make a mess of things.
- CSN5 I get chores done right away.

**OPN = Openness to new experiences**

- OPN1 I have a rich vocabulary.
- OPN2 I have difficulty understanding abstract ideas.
- OPN3 I have a vivid imagination.
- OPN4 I am not interested in abstract ideas.
- OPN5 I have excellent ideas.

</details> 
<br>
```{r load data}
## load data
big5 <- readRDS("./data/big5.RDS")
```

Let's take a quick look at the data summary.

```{r, eval=FALSE}
## data summary
skim(big5)
```
<details>
  <summary>***See the data summary.***</summary>
```{r, echo=FALSE, eval=TRUE}
skim(big5)
```
</details> 
<br>


# Extract model parameters
As the first step to generate synthetic data, we extract the model parameters.

- Note that numbers are not allowed to be in the variable names. The variable names can only contain alphabetical characters.
Here I choose to change the numbers to *Roman numerals*. You are free to switch them to anything sensible to you though, as long as they consist only of characters.
- Once the variable names are sorted, get the `synds` object using using `synthpop` package. Currently, we only support method `"norm"` (for normally-distributed continuous variables) and `"logreg"`(for binary variables). Make sure you set `models=TRUE` when calling `syn` function.
- Next, use `synp_get_param` function, which takes the data and `synds` object as arguments to extract model parameters.

```{r cache=TRUE}
## convert the number in the variable names to Roman numeral
colnames(big5) <- c("EXT_I", "EXT_II", "EXT_III", "EXT_IV", "EXT_V", 
                    "EST_I", "EST_II", "EST_III", "EST_IV",  "EST_V", 
                    "AGR_I", "AGR_II", "AGR_III", "AGR_IV",  "AGR_V", 
                    "CSN_I", "CSN_II", "CSN_III", "CSN_IV", "CSN_V", 
                    "OPN_I", "OPN_II", "OPN_III", "OPN_IV", "OPN_V")
## get the synds object
synds <- syn(big5, method="norm", models=TRUE)
## extract parameters and store them as "model_par"
model_par <- synp_get_param(big5, synds)
```


# Save to Excel & Export from CBS
We export the model parameters to Excel using `writexl` package: `write_xlsx(list of dataframes, filepath)`. Then, you would be able to export the xlsx file from the CBS environment through the regular output check and store it on your local device.

```{r}
## export to Excel
write_xlsx(model_par, "big5.xlsx")
```

# Read xlsx file into R
We read in the model parameters from xlsx file using `synp_read_sheets` function: `synp_read_sheets(filepath)`.
```{r}
## read in the parameters
parameters <- synp_read_sheets("big5.xlsx")
```

# Generate synthetic data
We can generate the synthetic data using `synp_gen_syndat` function: `synp_gen_syndat(list of parameters, n = sample size)`.
```{r}
## generate synthetic data
syndat <- synp_gen_syndat(parameters, n = nrow(big5))
```
```{r, eval=FALSE}
## check the synthetic data
head(syndat)
```
<details>
  <summary>***Check the synthetic data.***</summary>
```{r, echo=FALSE, eval=TRUE}
head(syndat)
```
</details>
<br>


# Run analysis on synthetic data
Here, we run (confirmatory) factor analysis on the synthesized Big5 personality data.
Later on, we run the same analysis on the original data and compare the results to see if both data sets lead to more or less the same conclusion.
```{r}
## lavaan model formulae
CFA_model <- '
EXTRA =~ EXT_I + EXT_II + EXT_III + EXT_IV + EXT_V 
AGREE =~ AGR_I + AGR_II + AGR_III + AGR_IV + AGR_V 
EMO   =~ EST_I + EST_II + EST_III + EST_IV + EST_V 
OPEN  =~ OPN_I + OPN_II + OPN_III + OPN_IV + OPN_V
CON   =~ CSN_I + CSN_II + CSN_III + CSN_IV + CSN_V 
'
## run CFA on synthetic data
syn_CFA <- cfa(model = CFA_model, data = syndat, std.lv=TRUE)
## assess the fit indices
fitMeasures(syn_CFA, fit.measures = c("cfi","srmr", "rmsea"))
```
<details>
  <summary>***Check the CFA (on synthetic data) results in detail.***</summary>
```{r, echo=FALSE, eval=TRUE}
summary(syn_CFA, fit.measures = TRUE, standardized = TRUE)
```
</details>
<br>

```{r}
## plot the CFA model on synthetic data
lavaanPlot(model = syn_CFA, node_options = list(shape = "box", fontname = "Helvetica"), edge_options = list(color = "grey"), coefs = TRUE, graph_options = list(layout = "circo"))

```

# Run analysis on original data
```{r}
## run CFA on original data
original_CFA <- cfa(model = CFA_model, data = big5, std.lv=TRUE)
## assess the fit indices
fitMeasures(original_CFA, fit.measures = c("cfi","srmr", "rmsea"))
```
<details>
  <summary>***Check the CFA (on original data) results in detail.***</summary>
```{r, echo=FALSE, eval=TRUE}
 summary(original_CFA, fit.measures = TRUE, standardized = TRUE)
```
</details>
<br>

```{r}
## plot the CFA model on original data
lavaanPlot(model = original_CFA, node_options = list(shape = "box", fontname = "Helvetica"), edge_options = list(color = "grey"), coefs = TRUE, graph_options = list(layout = "circo"))

```


<hr>
As seen above in the plots as well as in the table below, it is observed that the resulting estimates from the factor analysis on the synthetic data closely coincide with those from the analysis on the original data.


```{r echo=FALSE}
original_est <- parameterEstimates(original_CFA) %>% 
  filter(grepl('V', rhs) & op == '=~')  %>% 
  dplyr::select(est, se) %>% 
  rename(Original_estimate = est, Original_se = se)

parameterEstimates(syn_CFA) %>% 
  filter(grepl('V', rhs) & op == '=~') %>% 
  dplyr::select(lhs:se) %>% 
  unite("Formula", lhs:rhs, sep=" ") %>% 
  rename(Synthetic_estimate = est, Synthetic_se = se) %>% 
  cbind(original_est) %>% 
  relocate(Formula, Synthetic_estimate, Original_estimate, Synthetic_se, Original_se) %>% 
  mutate(across(where(is.numeric), round, 3)) %>% 
  knitr::kable(align = "lcccc", format="html") %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```



